アニメのキャラクターを「タメ／ツメ」を意識して、2コマ／3コマ打ちにするために、「被写体がどれだけ激しく動いているか」を定量化する手法を、アニメーション制作の文脈も踏まえて具体的に考えてみます。

リアルタイム性をあまり考えず、あとから処理できる前提ですね。そうすると計算コストや複雑さはある程度許容できるので、精度重視の方法も使えます。

以下、まずアニメ／コマ打ち・タメツメの背景を簡単に整理し、それを踏まえて「動きの激しさ」を測るための具体的な特徴量／指標案を挙げ、最後にそれを使ってコマ打ちを決める設計案を示します。

タメ／ツメ／コマ打ちの背景

「タメ（溜め）」とは、動きの始まり側や中で、速度を抑えて（動きがゆっくり）ポーズを強調する部分。ポーズを保つ時間を長く取る。 
shade3d.jp

「ツメ（詰め）」とは、動きの速い部分を強く出す、中割り（in-between）の枚数を少なくしたり、間を詰めて動きを速く見せる部分。 
アットウィキ
+1

コマ打ち（2コマ打ち、3コマ打ちなど）は、絵と絵の間をどれだけ間引くか、すなわち中間フレームをどれだけ省くかの表現手法。動きの種類・移動量・見せたいスピード感などに応じてコマ数を調整する。 
動く出版社 フィルムアート社
+2
アットウィキ
+2

要するに、「動きが激しいところ」はコマを詰めて（少ないコマで速く見せる）、動きが遅めかポーズを見せたいところはタメを設けてコマを間引かない・または同じポーズを複数コマ保持する、という操作になります。

動きの激しさを測るための特徴量・指標案

「どれだけ激しく動いているか」を数値化するための情報・指標を、アニメのキャラクター動画に対して使えるものを洗い出すと以下のようになります。

指標／特徴量	内容	2コマ／3コマ打ちの決定との関係
2D変位量 (Screen displacement)	フレーム間でキャラクターあるいはキーポイント（関節、手・足先・腕先など）が画面上でどれだけ動いたか（ピクセル距離）	大きい変位 → コマ打ちを詰めたい（2コマ等）／中割りを少なくする。小さい変位ならタメをおきやすい。
速度変化率（速度の変動）	前後フレーム間の速度差。たとえば、加速／減速している部分。	動きが加速してツメが入りやすい部分、または始動前のタメを置くべき部分の候補になる。
曲線の変化量／軌道の角度変化	動きの方向が劇的に変わる — 例えば腕を振る、方向を急に変える動き。角度変化が大きいところは視覚的インパクトが強くなる。	その部分をコマ数を増やして中割りをしっかり入れるか、または逆に「演出として飛ばす」かの判断材料になる。動きの激しい方向転換では滑らかさを保つためコマ数を詰めないこともある。
加速度／減速度	速度の変化率そのもの。動きが急に始まったり止まるところ。	コマ打ちを詰めたりタメを入れるかどうかを決めるのに有効。たとえば加速の始まりでタメを置いてから速く動かす（ツメ）など。
奥行き方向の動き	被写体が奥（遠ざかる）→手前（近づく）等、3D的に動いているか。深度情報があれば取得できる。	奥行き方向の動きがあると、2D変位が小さくても動きの激しさがあると感じるので、適切にコマ打ち／中割りを判断するために深度補正を入れる。
ポーズの変化の大きさ／形状の変化	ボディポーズ（関節角度／体のひねり／手足の位置など）がどれだけ変化しているか。ポーズが劇的に変わる場所は視覚的に重要。	キーフレームとして残すべき。中割りを多く、またコマ詰めを控える。「タメ」のポーズを強調する部分として認識できる。
動きのリズム／周期性	動きが繰り返し／定期的な振動／揺れなどを含むかどうか。	リズムの変化点（振動が強まる／弱まる）でコマ打ちを変えると表現効果が出る。
画面の構成・被写体のサイズ・位置	キャラが画面の端から端まで動くか／大きく見えるか／視野いっぱいかどうかなど。	大きく動くときはコマ詰めが必要。小さく動くときはコマ打ちを間引いても見た目は問題ない。
線の動き・ラインの歪み・モーションブラー／残像表現	キャラクターの線がぶれていたり、残像風の線がついたりする演出があるか。	動きが速い部分でこういった「流れ（軌跡）」を強めると、少ないコマでも速さを感じさせる。コマ打ちの詰め具合を減らしても動きが滑らかに感じられる補助になる。
シーンの演出的意図	例えば、「衝撃を強調したい」「セリフパートで静かに見せたい」など演出上どんな雰囲気を持たせたいか。	定量ではないが最終判断込み。動きが激しくても演出的にタメを長めに置きたいこともある。
測定可能な技術手段・データ取得

動きの激しさを上の指標で測るには、以下のようなデータ・前処理が必要／有効：

キーポイント／ボーン構造の取得
　キャラクターの関節・手足先・頭などの2D／3Dキーポイント。Pose Estimation（2D）や 3Dポーズ推定モデルを使う。

深度情報
　もし3Dアニメーションモデルから出力されていれば、ボーン／モデルデータから直接3D座標が取得できる。そうでなければ、単眼深度推定モデル／ステレオ撮影などから深度マップを得る。

フレーム間の時間間隔
　アニメ動画のコマ数とフレームレートを知っておく。たとえば元が24 fps なら、2コマ打ちは 12 fps 相当など。時間あたりの移動速度や加速度を求めるのに必要。

画面解像度・スケール情報
　キャラクターがどれだけのピクセルを占めているか。被写体と画面サイズの関係を知ると、画面上の変位を「視覚的な距離」「見やすさ」などに変換しやすい。

アニメーションの原画／モデルポーズデータ
　もしモデルデータ（3Dキャラクター）やボーン付きアニメーションがベースなら、移動や回転などを直接数値で取得できるので楽。

線画・ストローク情報（演出的な線の表現）
　線のゆがみ／流線／残像等の演出があるなら、それらを検出できると、動きの速度感の補助指標になる。

履歴情報
　過去のフレームでの動き履歴（速度・加速度）を貯めること。急変を検出するため。

指標設計案：動きの激しさスコア

これらの指標を使って、「動きを激しいかどうか」「どのくらいコマを詰めるか（2コマ／3コマ／1コマ打ちなど）」を決められるスコア設計案を以下に示します。

各フレーム（あるいはフレーム区間）の特徴量を計算：

Δpos = キーポイントの位置変化量（2Dピクセル）平均／最大

Δdir = 動き方向の変化量（たとえば前フレーム→現フレーム→次フレームのベクトルのなす角度）

v = 速度 = Δpos / Δtime

a = 加速度 = (v_cur − v_prev) / Δtime

depth_change = 奥行き方向の位置変化量が分かるならそれも含めた 3D 変位量

pose_change = 関節角度などポーズの変形量

size_factor = 被写体が画面占有率大きいかどうか

正規化・重み付けして「激しさスコア (Motion Intensity)」を作る：

例

MotionIntensity = w1 * norm(Δpos) + w2 * norm(depth_change) + w3 * norm(v) + w4 * norm(a) + w5 * pose_change * size_factor


ここで norm(...) はそれぞれの特徴をスケール正規化したもの、w_i は用途に応じた重み。

閾値決定または階層化：

MotionIntensity が 高い → コマ打ちを詰める（2コマまたは1コマ打ち）

MotionIntensity が 中程度 → 3コマ打ちなど中間

MotionIntensity が 低い → タメを取り、中割りを沢山使うかポーズを保持する

タメ／ツメポイントの検出：

加速度が正から負に変わる（ピーク速度）や、速度が急激に上がる直前などをツメ開始点とする

動きが遅く一旦ほぼ停止するようなところをタメ、安全にポーズを見せることができる場所

コマ打ちパターンの適用：

動きが激しい区間に対して、例えば 2コマ打ちにする

動きが最も激しい区間には 1コマ打ち（もし滑らかさ／リソース許せば）

タメを取る部分／ツメを詰める部分の境界を滑らかに中割りを調整して設計

実装・ワークフロー案

これを実際のアニメ素材に適用するなら、以下のような流れ＋注意点が考えられます：

素材の準備
　できれば元データとしてボーンアニメーション／キーポーズ情報があるものを使うと便利。2D手描きセルアニメ等なら、キーポイント追跡・姿勢推定モデルなどを使ってポーズ情報を取得。

キーポイント・ポーズ取得
　各フレームで関節／手足先などの 2D ポーズ。可能なら深度も。OpenPose や MediaPipe、あるいはアニメ専用モデル、また 3D モデルがあれば直接ボーン情報。

速度・変位・加速度計算

フレーム間で移動量を取る

時間 Δt をフレームレートから取得

速度＆加速度を取る

スコアリング
　前述の MotionIntensity を各フレームまたは区間に対して計算。

コマ打ち案の生成

各区間に対して「コマ落とし」案を自動でラベル付け（例：激しい → 2コマ打ち／非常に激しい → 1コマ打ち）

タメ部分としてポーズ変化が小さく速度が低めな区間を検出 → コマ数を落とさない・ポーズ保持

出力：実際にコマ打ち

フレーム選択または中割り削減を行う

必要なら中間ポーズ補完（補間）を入れる

評価・修正

出力を目視で確認。特に速い動きでコマ打ちを詰めたがために違和感がないか

演出的な意図（ドラマ性、強調したい部分）が適切かどうかを確認

もしいいなら、あなたの具体的な素材（例えば、2Dセルアニメーションか、3Dモデルか・フレームレートはいくつか・キーポーズ／ボーン情報があるかどうか）を伺って、それに即した動きの激しさスコアの具体式を設計できます。どうしますか？


いい追加情報ありがとう — 2Dセルアニメ向け、\*\*タメ／ツメを意識して自動で「2コマ／3コマ落ち」するための具体式（数式＋実装フロー）\*\*を作ります。さらに、同種の先行研究（2D・2.5D/3D 問わず）についても要点と代表的な論文・記事を挙げます。

---

# 要点まとめ（結論先出し）

* 入力：各フレームでの **キャラの複数キーポイント位置**（2D pixel）、フレームレート `fps`、各フレームのキャラの **バウンディングボックス（サイズ）**。可能なら\*\*関節角度（pose）\*\*も。
* 出力：各フレーム（または区間）についての **MotionIntensity (0..1)**（動きの激しさスコア）と、しきい値に基づく **コマ落ちラベル**（例：保持／3コマ落ち／2コマ落ち／1コマ（原画））。
* 方式：キーポイントの正規化変位・速度・加速度・ポーズ変化を重み付け和で合成。しきい値＋ヒステリシスでコマ落ちを決定。
* 参考・関連分野：自動中割り（inbetweening）研究、キーフレーム抽出、光学フローや動画サリエンシー研究などが近い先行領域。代表例を下に引用します。([cs.toronto.edu][1])

---

# 1）具体式（数式） — MotionIntensity の定義

前提：

* フレームインデックスを `t`、フレーム間時間 Δt = 1/fps。
* キーポイントは `p_i(t) = (x_i(t), y_i(t))`、i = 1..N（例えば頭・両手・両足・胴など）。
* キャラの画面スケールは `S(t)`（例：バウンディングボックスの対角長：ピクセル）。これでピクセル依存性を除去する。

まず基本量を計算：

1. **正規化変位（Normalized displacement）**
   各キーポイントのフレーム間変位（ピクセル）をキャラスケールで割る：

   $$
   d_i(t) = \frac{\| p_i(t) - p_i(t-1) \|}{S(t)}
   $$

   区間意味づけのために、フレーム t の代表値を **平均** とする：

   $$
   D(t) = \frac{1}{N} \sum_{i=1}^N d_i(t)
   $$

2. **速度（normalized）**

   $$
   v_i(t) = \frac{d_i(t)}{\Delta t},\qquad V(t)=\frac{1}{N}\sum_i v_i(t)
   $$

3. **加速度（normalized）**

   $$
   a_i(t) = \frac{v_i(t) - v_i(t-1)}{\Delta t},\qquad A(t)=\frac{1}{N}\sum_i a_i(t)
   $$

4. **方向変化量（direction change）**
   連続 3 フレームを見て動き方向の角度変化を計算：キーポイントごとのベクトル `u_i(t)=p_i(t)-p_i(t-1)` と `u_i(t-1)` のなす角の絶対値の平均：

   $$
   \theta_i(t)=\arccos\left( \frac{u_i(t)\cdot u_i(t-1)}{\|u_i(t)\|\|u_i(t-1)\|+\epsilon} \right)
   $$

   $$
   \Theta(t)=\frac{1}{N}\sum_i \frac{\theta_i(t)}{\pi} \quad(\text{正規化して }0..1)
   $$

5. **ポーズ変化量（pose change）** — 関節角度が取れるなら：
   関節角度差の平均 `P(t)`（正規化して 0..1）。

正規化（各量を 0..1 にスケール）：

* 実装上は過去分布（移動量の標準偏差や上位パーセンタイル）を使ってクリッピング・正規化すると安定します。簡易では最大期待値 `maxD, maxV, maxA` を決めて `clamp(x/max,0,1)`。

合成：重み付き和で MotionIntensity を作る：

$$
MI(t) = w_D \, \tilde{D}(t) + w_V \, \tilde{V}(t) + w_A \, \tilde{A}(t) + w_\Theta \, \tilde{\Theta}(t) + w_P \, \tilde{P}(t)
$$

ここで $\tilde{\cdot}$ は正規化済みの量、重み $w_*$ は合計 1 に正規化して用いる。

**デフォルト（出発点）重みの例**：

* $w_D=0.30,\; w_V=0.25,\; w_A=0.20,\; w_\Theta=0.15,\; w_P=0.10$

（理由：移動量と速度を重視し、加速度でツメの開始／終了を拾う。方向変化とポーズ変形も補助的に評価。）

---

# 2）コマ落ち判定ルール（閾値例）

MI は 0..1。下記は調整可能なデフォルト。

* `MI >= 0.60` → **2コマ打ち（高速寄り）**
* `0.35 <= MI < 0.60` → **3コマ打ち（中速）**
* `MI < 0.35` → **保持／タメ（コマ落とさない or 同ポーズ延長）**

ただしフリッカー（毎フレームラベルが大きく凸凹する）を避けるために **ヒステリシス（閾値に ±δ）** と **最小区間長（例：0.1秒以上 = floor(fps\*0.1) フレーム）** を入れるのが有効。

さらに「ツメ（詰め）」を意識するには：

* **ツメの開始検出**：`A(t)`（加速度）が大きく正に立ち上がる直前をタメ始点に候補 → その手前のフレームを **保持（タメ）** にする（例：前フレーム 3..6 コマを保持）。
* **ツメの最中**：MI が高い区間はコマを詰める（上記ルール）。
* **タメの強調**：速度が極端に低く、ポーズ変化も低い区間はポーズを N フレーム延長（N は演出パラメータ）。

（注：この設計は「タメ→ツメ」の構成を自動的に検出して、ツメ直前にタメを残す動作ができるように、加速度や速度立ち上がりを利用している点がポイントです。）

---

# 3）実装フロー（擬似コード）

1. 入力フレーム列、fps、キーポイント列、bbox→S(t) を計算
2. 各フレームについて D,V,A,Θ,P を計算・正規化
3. MI を計算
4. 平滑化（例えば EMA or 小窓平均）をかける
5. 閾値ヒステリシス＋最小区間長でラベルを決定（保持／3コマ／2コマ等）
6. ラベルに従ってフレームを出力（コマ落とし）＋必要なら中割り補正やモーションブラーを付与

簡易擬似：

```
for t in range(1, T):
  compute D,V,A,Theta,P
  normalize -> Dn,Vn,An,Thn,Pn
  MI[t] = wD*Dn + wV*Vn + wA*An + wTh*Thn + wP*Pn

MI_smoothed = lowpass(MI)
labels = hysteresis_thresholding(MI_smoothed, thresholds=[0.35,0.60], min_len=ceil(0.08*fps))
apply_labels_to_frames(labels)
```

---

# 4）実験上の実践ヒント（2Dセルに特に効く工夫）

* **キャラ単位で正規化**：複数キャラがいる場合はキャラ別に S(t) を計算して MI を出す。背景の動きは無視する。
* **キー部位重みづけ**：手足先や頭など「視覚的重要点」の動きに重みを増やすと、演出的な印象に合いやすい（例：手の大きい振り→ツメにしたい）。
* **残像（smear）やモーションブラー挿入**：コマ落としでカクつきが出る場合、速度成分の高いフレームに残像を合成すると見た目が良くなる。
* **閾値自動調整**：素材全体の MI 分布に基づいて閾値を自動決定（例：上位 20% を高速扱い）してもよい。
* **UIで手動微調整できるようにする**：最終は演出判断なので、スライダで重み/閾値を調整できると実用的。

---

# 5）先行研究（ハイライトと実務上の近接領域）

**自動中割り（inbetweening）**・**キーフレーム抽出**・**動画サリエンシー（motion saliency）**・**光学フローを使ったモーション計測**が関連領域です。2Dセルアニメに特化した自動中割りや「キーフレーム抽出」研究は多く、また「動きの激しさ」を指標に動画中の重要フレームを選ぶ研究（ビデオサマリやサリエンシー検出）もあります。

代表例（読んでおくと役に立ちます）：

* **Deep Animation Inbetweening** — 2Dアニメに対する inbetweening の研究（学術的・実用的な手法）。自動で中間フレームを生成する方向だが、キーフレーム抽出や動きの扱いの参考に。([cs.toronto.edu][1])
* **BetweenIT: An Interactive Tool for Tight Inbetweening（Disney Research）** — 実制作向けのインタラクティブな中割り生成ツールの研究。中割り生成や表現制御に関する考え方が参考になる。([studios.disneyresearch.com][2])
* **Stroke-based / Painterly Inbetweening** — 手描き風表現を考慮した中割り研究（2D特化の最新手法もあり）。([Wiley Online Library][3])
* **光学フロー + エッジ重みを用いる動画サリエンシー / 動き検出の研究** — 動き情報（optical flow）を利用して重要部分を抽出する研究群。MI の算出において optical flow を用いるのは一般的で有効です。([University of Portsmouth][4])
* **キーフレーム抽出（クラスタリング等）** — 動画から重要フレームを抽出する研究（汎用手法）。閾値自動決定や分布ベースの手法は参考になります。([PMC][5])

（要約：**自動で“どのフレームを残す/捨てる”かを決める研究は多く**、2Dセルに限定した自動中割りは特に盛ん。あなたの目的は「落とす（間引く）」方針なので、キーフレーム抽出＋動きの激しさスコア化が最も近いアプローチになります。）([cs.toronto.edu][1])

---

# 6）評価方法（実験案）

* **定量評価**：人間評価（A/B テストで「自然さ」「勢いの出方」「タメ感」を比較）。自動指標としてはフレーム間の平均画素差（急激なジャンプの検出）や、動きの連続性（速度の平滑さ）を使う。
* **ユーザビリティ**：アーティストが微調整しやすいよう、MI の時系列プロットと「ラベル提案」を UI 表示するのがおすすめ。

---

# 7）サンプル数値例（現場でのスタート設定）

* fps=24。S(t) = bbox diagonal。N=8 keypoints（頭・首・肩左右・手首左右・腰・両足基点 等）。
* maxD=0.2（体スケールに対して 0.2 を上限）、maxV= maxD / Δt、maxA = (maxV)/Δt でクリップ。
* しきい値： \[0.35, 0.60]、ヒステリシス幅 δ=0.05、最小区間長 = 2 フレーム（≈0.08s）。
  （これで試して、視覚的に高速と判定された区間は 2 コマ、やや速い区間は 3 コマ、低い領域は保持に落ち着くはず）

---

# 8）追加の改善案（発展）

* **optical flow（RAFT 等）を併用**して、キーポイントトラッキングが不安定な箇所を補完する（ピクセルレベルの動き情報が得られる）。([University of Portsmouth][4])
* **学習ベース判定器**：上の MI を入力特徴量に、実際のアニメ作例で人が選んだコマ打ちラベルを教師データにして分類器を学習すると、演出的な判定がより人間寄りになる。([arXiv][6])
* **スミア／残像生成自動化**：高速区間で残像を付ける判定も MI を使って自動化する（演出を補完）。([Wiley Online Library][3])

---

# 参考文献（抜粋）

* Li, Tianxing et al., *Deep Animation Inbetweening* (ECCV submission / arXiv). （2Dアニメ向け自動中割り）. ([cs.toronto.edu][1])
* BetweenIT: An Interactive Tool for Tight Inbetweening — Disney Research. （制作現場に近い中割り支援研究）. ([studios.disneyresearch.com][2])
* *Optical flow + edge weighting for video saliency* (Flow-Edge-Net) — 光学フローを使った動き検出／サリエンシー。MI の基礎として参考。([University of Portsmouth][4])
* *Automatic Inbetweening for Stroke‐Based Painterly Animation* — 手描き風中割り研究（2D寄り）。([Wiley Online Library][3])
* キーフレーム抽出・動画サマリ研究（クラスタリング系・統計的手法）。([PMC][5])

---

# 最後に — 実装で試してみたいこと（提案）

1. あなたの手元にある **テストクリップ 3〜5 本**（短くて OK）を使って、上の MI とデフォルト重み・閾値で自動処理してみましょう。
2. 出力のタイムライン（MI プロット）とラベル提案を可視化し、**人の目で確認して重み/閾値を微調整**。
3. 必要なら optical flow を付け足して、キーポイントで取り切れない動きを補う。
4. 最終的に「ツメの直前を 2〜6 フレームタメで残す」といったルール（加速度で検出）を手動の演出プリセットとして保存しておく。

---

やってみますか？

* もし**実際の短いサンプル動画**（またはキーポイント列の CSV）を渡してくれれば、私の側で上の式を具体の数値で計算して**MI の時系列プロット＋自動ラベル例**を作れます（ただしファイルアップロードが必要です）。
* まずは式の重みや閾値を変えてどれが見た目に近いか、あなたの好みに合わせてチューニングしていくのが速いです。どれを試しますか？

[1]: https://www.cs.toronto.edu/~tianxingli/assets/inbetweening_submission_eccv.pdf?utm_source=chatgpt.com "[PDF] Deep Animation Inbetweening"
[2]: https://studios.disneyresearch.com/wp-content/uploads/2019/03/BetweenIT-An-Interactive-Tool-for-Tight-Inbetweening-Paper.pdf?utm_source=chatgpt.com "[PDF] BetweenIT: An Interactive Tool for Tight Inbetweening"
[3]: https://onlinelibrary.wiley.com/doi/full/10.1111/cgf.15201?utm_source=chatgpt.com "Automatic Inbetweening for Stroke‐Based Painterly Animation"
[4]: https://researchportal.port.ac.uk/files/81124917/Flow-Edge-Net_PP.pdf?utm_source=chatgpt.com "[PDF] Video Saliency Detection based on Optical Flow and Edge ..."
[5]: https://pmc.ncbi.nlm.nih.gov/articles/PMC3916911/?utm_source=chatgpt.com "An Efficient Method of Key-Frame Extraction Based on a Cluster ..."
[6]: https://arxiv.org/html/2407.00925v1?utm_source=chatgpt.com "SIDQL: An Efficient Keyframe Extraction and Motion Reconstruction ..."

